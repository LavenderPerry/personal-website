name: Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploy
    
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get -y install make lftp cmark-gfm

    - name: Install Soupault
      env:
        SOUPAULT_VERSION: 4.11.0
      run: |
        wget "https://github.com/PataphysicalSociety/soupault/releases/download/4.11.0/soupault-$SOUPAULT_VERSION-linux-x86_64.tar.gz"
        tar xvf soupault-$SOUPAULT_VERSION-linux-x86_64.tar.gz
        sudo mv -v ./soupault-$SOUPAULT_VERSION-linux-x86_64/soupault /usr/bin/

    - name: Build website
      run: make all

    - name: Push to Nekoweb
      # Uploads to Nekoweb FTP
      # Modified from https://github.com/GenieTim/ftp-action
      env:
        HOST: ftp.nekoweb.org:30000
        USER: lavender
        LOCAL_DIR: build
        REMOTE_DIR: /
        FORCESSL: false
      run:
        lftp $HOST -u $USER,${{ secrets.NEKOWEB_APIKEY }} -e "
          set net:timeout 60;
          set net:max-retries 20;
          set net:reconnect-interval-multiplier 2;
          set net:reconnect-interval-base 5;
          set ftp:ssl-force $FORCESSL; 
          set sftp:auto-confirm yes;
          set ssl:verify-certificate $FORCESSL; 
          mirror -v -P 5 -R -n -L -x ^\.git/$ $LOCAL_DIR $REMOTE_DIR;
          quit
        "
